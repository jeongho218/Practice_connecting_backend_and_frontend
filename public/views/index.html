<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Bootstrap CSS 파일을 CDN을 통해 불러옵니다 -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <title>메인 페이지</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <div class="d-flex">
          <a href="/views" class="btn btn-link me-2 text-light">홈</a>
          <a href="/views/mypage" class="btn btn-link me-2 text-light"
            >마이페이지</a
          >
          <a href="/views/posts.html" class="btn btn-link me-2 text-light"
            >게시글</a
          >
          <a href="/views/comments.html" class="btn btn-link text-light"
            >댓글</a
          >
        </div>

        <div class="d-flex">
          <button
            type="button"
            class="btn btn-primary me-2"
            id="signupButton"
            data-bs-toggle="modal"
            data-bs-target="#signupModal"
          >
            회원가입
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            id="loginButton"
            data-bs-toggle="modal"
            data-bs-target="#loginModal"
          >
            로그인
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            id="logoutButton"
            style="display: none"
            onclick="handleLogout()"
          >
            로그아웃
          </button>
        </div>
      </div>
    </nav>
    <div class="container mt-5">
      <!-- 히어로 영역 시작 -->
      <div
        class="hero-container"
        style="position: relative; max-width: 100%; overflow: hidden"
      >
        <img
          src="https://img.freepik.com/free-photo/cup-coffee-table-front-street-with-city-lights-background_188544-10293.jpg?size=626&ext=jpg&ga=GA1.1.386372595.1698278400&semt=ais"
          alt="히어로 이미지"
          style="
            width: 100%;
            height: auto;
            display: block;
            filter: brightness(50%);
          "
        />

        <p
          class="hero-text"
          style="
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: white;
            text-align: center;
          "
        >
          프론트엔드 테스팅 중입니다.
        </p>
      </div>
      <!-- 히어로 영역 끝 -->
    </div>

    <!-- 알림 메시지 시작 -->
    <div
      class="alert alert-success d-none"
      id="alertSuccessMessage"
      role="alert"
    >
      회원 가입이 성공적으로 완료되었습니다.
      <a href="#" class="alert-link" onclick="closeAlert('alertSuccessMessage')"
        >닫기</a
      >
    </div>

    <div
      class="alert alert-danger d-none"
      id="alertFailureMessage"
      role="alert"
    >
      회원 가입에 실패했습니다. 다시 시도하세요.
      <a href="#" class="alert-link" onclick="closeAlert('alertFailureMessage')"
        >닫기</a
      >
    </div>

    <div
      class="alert alert-success d-none"
      id="alertLoginSuccessMessage"
      role="alert"
    >
      로그인이 성공적으로 완료되었습니다.
      <a
        href="#"
        class="alert-link"
        onclick="closeAlert('alertLoginSuccessMessage')"
        >닫기</a
      >
    </div>

    <div
      class="alert alert-danger d-none"
      id="alertLoginFailureMessage"
      role="alert"
    >
      로그인에 실패하였습니다.
      <a
        href="#"
        class="alert-link"
        onclick="closeAlert('alertLoginFailureMessage')"
        >닫기</a
      >
    </div>

    <div
      class="alert alert-success d-none"
      id="alertLogoutSuccessMessage"
      role="alert"
    >
      성공적으로 로그아웃하였습니다.
      <a
        href="#"
        class="alert-link"
        onclick="closeAlert('alertLogoutSuccessMessage')"
        >닫기</a
      >
    </div>

    <div
      class="alert alert-danger d-none"
      id="alertLogoutFailureMessage"
      role="alert"
    >
      로그아웃에 실패하였습니다.
      <a
        href="#"
        class="alert-link"
        onclick="closeAlert('alertLogoutFailureMessage')"
        >닫기</a
      >
    </div>
    <!-- 알림 메시지 끝 -->

    <!-- 팝업 모달 창 -->
    <div
      class="modal fade"
      id="signupModal"
      tabindex="-1"
      aria-labelledby="signupModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="signupModalLabel">회원 가입</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="email" class="form-label">이메일</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  placeholder="이메일을 입력하세요"
                />
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">비밀번호</label>
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  placeholder="비밀번호를 입력하세요"
                />
              </div>
              <div class="mb-3">
                <label for="name" class="form-label">이름</label>
                <input
                  type="text"
                  class="form-control"
                  id="name"
                  placeholder="이름을 입력하세요"
                />
              </div>
              <div class="mb-3">
                <label for="age" class="form-label">나이</label>
                <input
                  type="number"
                  class="form-control"
                  id="age"
                  placeholder="나이를 입력하세요"
                />
              </div>
              <div class="mb-3">
                <label for="gender" class="form-label">성별</label>
                <select class="form-select" id="gender">
                  <option value="male">남성</option>
                  <option value="female">여성</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="profileImage" class="form-label"
                  >프로필 이미지 URL</label
                >
                <input
                  type="url"
                  class="form-control"
                  id="profileImage"
                  placeholder="프로필 이미지 URL을 입력하세요"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              닫기
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="submitSignUpForm()"
              data-bs-dismiss="modal"
            >
              가입 완료
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 로그인 모달 창 -->
    <div
      class="modal fade"
      id="loginModal"
      tabindex="-1"
      aria-labelledby="loginModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">로그인</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="loginEmail" class="form-label">이메일</label>
                <input
                  type="email"
                  class="form-control"
                  id="loginEmail"
                  placeholder="이메일을 입력하세요"
                />
              </div>
              <div class="mb-3">
                <label for="loginPassword" class="form-label">비밀번호</label>
                <input
                  type="password"
                  class="form-control"
                  id="loginPassword"
                  placeholder="비밀번호를 입력하세요"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              닫기
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="submitLoginForm()"
              data-bs-dismiss="modal"
            >
              로그인
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap CSS 파일을 CDN을 통해 불러옵니다 -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />

    <!-- Bootstrap JavaScript 파일을 CDN을 통해 불러옵니다 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <script>
      checkUserStatus();

      // 사용자 상태 확인
      function checkUserStatus() {
        fetch("/api/users/me")
          .then((response) => response.json())
          .then((data) => {
            if (data && data.data && data.data.email) {
              // 사용자가 로그인되어 있는 경우 '회원가입', '로그인' 버튼 숨김
              handleLoginSuccess();
            } else {
              // 사용자가 로그인되어 있지 않은 경우 '회원가입', '로그인 버튼'
              // handleLogout();
            }
          })
          .catch((error) => {
            console.error("오류:", error);
            handleLogout();
          });
      }

      // 회원가입 모달 닫힐 때 입력 칸 초기화
      $("#signupModal").on("hidden.bs.modal", function () {
        document.getElementById("email").value = "";
        document.getElementById("password").value = "";
        document.getElementById("name").value = "";
        document.getElementById("age").value = "";
        document.getElementById("gender").value = "male";
        document.getElementById("profileImage").value = "";
      });

      // 로그인 모달 닫힐 때 입력 칸 초기화
      $("#loginModal").on("hidden.bs.modal", function () {
        document.getElementById("loginEmail").value = "";
        document.getElementById("loginPassword").value = "";
      });

      // 알림 메세지 닫음
      function closeAlert(alertId) {
        document.getElementById(alertId).classList.add("d-none");
      }

      // 회원가입
      function submitSignUpForm() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const name = document.getElementById("name").value;
        const age = parseInt(document.getElementById("age").value);
        const gender = document.getElementById("gender").value;
        const profileImage = document.getElementById("profileImage").value;

        const userData = {
          email: email,
          password: password,
          name: name,
          age: age,
          gender: gender,
          profileImage: profileImage,
        };

        // 데이터를 JSON 형식으로 변환
        const jsonData = JSON.stringify(userData);

        // Fetch API 사용 AJAX 요청을 보냄
        fetch("/api/users", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: jsonData,
        })
          .then((response) => {
            if (response.ok) {
              console.log("가입이 완료되었습니다.");
              showSuccessAlert();
            } else {
              console.error("가입 요청 실패");
              showFailureAlert();
            }
          })
          .catch((error) => {
            console.error("오류:", error);
            showFailureAlert();
          });
      }

      // 회원가입 성공 알림
      function showSuccessAlert() {
        document
          .getElementById("alertSuccessMessage")
          .classList.remove("d-none");

        // 5초 후에 알림 닫음
        setTimeout(function () {
          closeAlert("alertSuccessMessage");
        }, 5000);
      }

      // 회원가입 실패 알림
      function showFailureAlert() {
        document
          .getElementById("alertFailureMessage")
          .classList.remove("d-none");

        // 5초 후에 알림 닫음
        setTimeout(function () {
          closeAlert("alertFailureMessage");
        }, 5000);
      }

      // 로그인
      function submitLoginForm() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        const loginData = {
          email: email,
          password: password,
        };

        // 데이터를 JSON 형식으로 변환
        const jsonData = JSON.stringify(loginData);

        // Fetch API 사용 AJAX 요청을 보냄
        fetch("/api/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: jsonData,
        })
          .then((response) => {
            if (response.ok) {
              console.log("로그인 성공");
              showLoginSuccessAlert();
              handleLoginSuccess();
            } else {
              console.error("로그인 실패");
              showLoginFailureAlert();
            }
          })
          .catch((error) => {
            console.error("오류:", error);
            showLoginFailureAlert();
          });
      }

      // 로그인 성공 시 호출되는 함수
      function handleLoginSuccess() {
        // 로그인 버튼과 회원가입 버튼을 숨김
        document.getElementById("loginButton").style.display = "none";
        document.getElementById("signupButton").style.display = "none";

        // 로그아웃 버튼을 표시
        document.getElementById("logoutButton").style.display = "block";
      }

      // 로그인 성공 알림
      function showLoginSuccessAlert() {
        document
          .getElementById("alertLoginSuccessMessage")
          .classList.remove("d-none");

        // 5초 후에 알림 닫음
        setTimeout(function () {
          closeAlert("alertLoginSuccessMessage");
        }, 5000);
      }

      // 로그인 실패 알림
      function showLoginFailureAlert() {
        document
          .getElementById("alertLoginFailureMessage")
          .classList.remove("d-none");

        // 5초 후에 알림 닫음
        setTimeout(function () {
          closeAlert("alertLoginFailureMessage");
        }, 5000);
      }

      // 로그아웃
      function handleLogout() {
        fetch("/api/logout", {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.message === "로그아웃 성공") {
              console.log("로그아웃 성공");
              showLogoutSuccessAlert();
              handleLogoutSuccess();
            } else {
              console.error("로그아웃 실패");
              showLogoutFailureAlert();
            }
          })
          .catch((error) => {
            console.error("오류:", error);
            showLogoutFailureAlert();
          });
      }

      // 로그아웃 성공 알림
      function showLogoutSuccessAlert() {
        document
          .getElementById("alertLogoutSuccessMessage")
          .classList.remove("d-none");

        // 5초 후에 알림 닫음
        setTimeout(function () {
          closeAlert("alertLogoutSuccessMessage");
        }, 5000);
      }

      // 로그아웃 실패 알림
      function showLogoutFailureAlert() {
        document
          .getElementById("alertLogoutFailureMessage")
          .classList.remove("d-none");

        // 5초 후에 알림 닫음
        setTimeout(function () {
          closeAlert("alertLogoutFailureMessage");
        }, 5000);
      }

      // 로그아웃 버튼 클릭 시 호출되는 함수
      function handleLogoutSuccess() {
        // 로그아웃 버튼을 숨김
        document.getElementById("logoutButton").style.display = "none";

        // 로그인 버튼과 회원가입 버튼을 다시 표시
        document.getElementById("loginButton").style.display = "block";
        document.getElementById("signupButton").style.display = "block";
      }
    </script>
  </body>
</html>
